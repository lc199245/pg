{"version":3,"sources":["../../../../src/services/renderer/passes/PostProcessor.ts"],"names":["inject","injectable","postConstruct","TYPES","PostProcessor","IRendererService","passes","readFBO","writeFBO","layer","i","length","pass","setRenderToScreen","isLastEnabledPass","render","swap","width","height","resize","config","init","push","index","splice","name","find","p","getName","isEnabled","tmp"],"mappings":";;;;;;;;;;AAAA,SAASA,MAAT,EAAiBC,UAAjB,EAA6BC,aAA7B,QAAkD,WAAlD;AACA,SAASC,KAAT,QAAsB,gBAAtB;IAYqBC,a,WADpBH,UAAU,E,UAERD,MAAM,CAACG,KAAK,CAACE,gBAAP,C,UAiENH,aAAa,E;;;;;;SA9DNI,M,GAA8C,E;SAC9CC,O;SACAC,Q;;;;;iCAEY;AAClB,aAAO,KAAKD,OAAZ;AACD;;;kCAEoB;AACnB,aAAO,KAAKC,QAAZ;AACD;;;;gFAEmBC,K;;;;;;AACTC,gBAAAA,C,GAAI,C;;;sBAAGA,CAAC,GAAG,KAAKJ,MAAL,CAAYK,M;;;;;AACxBC,gBAAAA,I,GAAO,KAAKN,MAAL,CAAYI,CAAZ,C;AAEbE,gBAAAA,IAAI,CAACC,iBAAL,CAAuB,KAAKC,iBAAL,CAAuBJ,CAAvB,CAAvB;;uBACME,IAAI,CAACG,MAAL,CAAYN,KAAZ,C;;;AAGN,oBAAIC,CAAC,KAAK,KAAKJ,MAAL,CAAYK,MAAZ,GAAqB,CAA/B,EAAkC;AAChC,uBAAKK,IAAL;AACD;;;AATqCN,gBAAAA,CAAC,E;;;;;;;;;;;;;;;;;;;;2BAa7BO,K,EAAeC,M,EAAgB;AAC3C,WAAKX,OAAL,CAAaY,MAAb,CAAoB;AAClBF,QAAAA,KAAK,EAALA,KADkB;AAElBC,QAAAA,MAAM,EAANA;AAFkB,OAApB;AAIA,WAAKV,QAAL,CAAcW,MAAd,CAAqB;AACnBF,QAAAA,KAAK,EAALA,KADmB;AAEnBC,QAAAA,MAAM,EAANA;AAFmB,OAArB;AAID;;;wBAGCN,I,EACAH,K,EACAW,M,EACA;AACAR,MAAAA,IAAI,CAACS,IAAL,CAAUZ,KAAV,EAAiBW,MAAjB;AACA,WAAKd,MAAL,CAAYgB,IAAZ,CAAiBV,IAAjB;AACD;;;2BAGCA,I,EACAW,K,EACAd,K,EACAW,M,EACA;AACAR,MAAAA,IAAI,CAACS,IAAL,CAAUZ,KAAV,EAAiBW,MAAjB;AACA,WAAKd,MAAL,CAAYkB,MAAZ,CAAmBD,KAAnB,EAA0B,CAA1B,EAA6BX,IAA7B;AACD;;;gDAGCa,I,EAC0C;AAC1C,aAAO,KAAKnB,MAAL,CAAYoB,IAAZ,CAAiB,UAACC,CAAD;AAAA,eAAOA,CAAC,CAACC,OAAF,OAAgBH,IAAvB;AAAA,OAAjB,CAAP;AACD;;;2BAGc,CAkBd;;;sCAEyBF,K,EAAwB;AAChD,WAAK,IAAIb,CAAC,GAAGa,KAAK,GAAG,CAArB,EAAwBb,CAAC,GAAG,KAAKJ,MAAL,CAAYK,MAAxC,EAAgDD,CAAC,EAAjD,EAAqD;AACnD,YAAI,KAAKJ,MAAL,CAAYI,CAAZ,EAAemB,SAAf,EAAJ,EAAgC;AAC9B,iBAAO,KAAP;AACD;AACF;;AACD,aAAO,IAAP;AACD;;;2BAEc;AACb,UAAMC,GAAG,GAAG,KAAKvB,OAAjB;AACA,WAAKA,OAAL,GAAe,KAAKC,QAApB;AACA,WAAKA,QAAL,GAAgBsB,GAAhB;AACD;;;;;;;;;;SApGkB1B,a","sourcesContent":["import { inject, injectable, postConstruct } from 'inversify';\nimport { TYPES } from '../../../types';\nimport { ILayer } from '../../layer/ILayerService';\nimport { gl } from '../gl';\nimport { IFramebuffer } from '../IFramebuffer';\nimport { IPostProcessingPass, IPostProcessor } from '../IMultiPassRenderer';\nimport { IRendererService } from '../IRendererService';\n\n/**\n * ported from Three.js EffectComposer\n * 后处理负责 pingpong read/write framebuffer，最后一个 pass 默认输出到屏幕\n */\n@injectable()\nexport default class PostProcessor implements IPostProcessor {\n  @inject(TYPES.IRendererService)\n  protected readonly rendererService: IRendererService;\n\n  private passes: Array<IPostProcessingPass<unknown>> = [];\n  private readFBO: IFramebuffer;\n  private writeFBO: IFramebuffer;\n\n  public getReadFBO() {\n    return this.readFBO;\n  }\n\n  public getWriteFBO() {\n    return this.writeFBO;\n  }\n\n  public async render(layer: ILayer) {\n    for (let i = 0; i < this.passes.length; i++) {\n      const pass = this.passes[i];\n      // last pass should render to screen\n      pass.setRenderToScreen(this.isLastEnabledPass(i));\n      await pass.render(layer);\n\n      // pingpong\n      if (i !== this.passes.length - 1) {\n        this.swap();\n      }\n    }\n  }\n\n  public resize(width: number, height: number) {\n    this.readFBO.resize({\n      width,\n      height,\n    });\n    this.writeFBO.resize({\n      width,\n      height,\n    });\n  }\n\n  public add<T>(\n    pass: IPostProcessingPass<T>,\n    layer: ILayer,\n    config?: Partial<T>,\n  ) {\n    pass.init(layer, config);\n    this.passes.push(pass);\n  }\n\n  public insert<T>(\n    pass: IPostProcessingPass<T>,\n    index: number,\n    layer: ILayer,\n    config?: Partial<T>,\n  ) {\n    pass.init(layer, config);\n    this.passes.splice(index, 0, pass);\n  }\n\n  public getPostProcessingPassByName(\n    name: string,\n  ): IPostProcessingPass<unknown> | undefined {\n    return this.passes.find((p) => p.getName() === name);\n  }\n\n  @postConstruct()\n  private init() {\n    // const { createFramebuffer, createTexture2D } = this.rendererService;\n    // this.readFBO = createFramebuffer({\n    //   color: createTexture2D({\n    //     width: 1,\n    //     height: 1,\n    //     wrapS: gl.CLAMP_TO_EDGE,\n    //     wrapT: gl.CLAMP_TO_EDGE,\n    //   }),\n    // });\n    // this.writeFBO = createFramebuffer({\n    //   color: createTexture2D({\n    //     width: 1,\n    //     height: 1,\n    //     wrapS: gl.CLAMP_TO_EDGE,\n    //     wrapT: gl.CLAMP_TO_EDGE,\n    //   }),\n    // });\n  }\n\n  private isLastEnabledPass(index: number): boolean {\n    for (let i = index + 1; i < this.passes.length; i++) {\n      if (this.passes[i].isEnabled()) {\n        return false;\n      }\n    }\n    return true;\n  }\n\n  private swap() {\n    const tmp = this.readFBO;\n    this.readFBO = this.writeFBO;\n    this.writeFBO = tmp;\n  }\n}\n"],"file":"PostProcessor.js"}